function [d2q, Fc] = Dynamics(q,dq,tau,contact)
    % B = [0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0;1,0,0,0,0,0,0,0,0,0;0,1,0,0,0,0,0,0,0,0;0,0,1,0,0,0,0,0,0,0;0,0,0,1,0,0,0,0,0,0;0,0,0,0,1,0,0,0,0,0;0,0,0,0,0,1,0,0,0,0;0,0,0,0,0,0,1,0,0,0;0,0,0,0,0,0,0,1,0,0;0,0,0,0,0,0,0,0,1,0;0,0,0,0,0,0,0,0,0,1];
    [D, ~, ~, J, dJ, h] = CassieDynamics_Full(q,dq,contact);
    Nc = rank(J);
    if Nc > 0
        [U,~,~] = svd(J');
        Un = U(:,Nc+1:end);% Uc = U(:,1:Nc);

        Dn = Un * (Un' * D * Un)^(-1) * Un';
        d2q0 = -pinv(J) * dJ * dq([1:6,7,8,9,10,13,14,15,16,17,20]);
        d2q = Dn * ([zeros(6,1);tau] - h - D * d2q0) + d2q0;
        Fc =  pinv(J') * (D * d2q + h - [zeros(6,1);tau]);
    else
        d2q = D^(-1) * ([zeros(6,1);tau] - h);
        Fc = 0;
    end
end
